{% extends "base.html" %}
{% block title %}Detalhes da Avaliação{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Detalhes da Avaliação #{{ avaliacao.id }}</h2>

    <!-- Exibir mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Abas para organizar as seções -->
    <ul class="nav nav-tabs mb-4" id="avaliacaoTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
                <i class="bi bi-info-circle me-1"></i> Informações Gerais
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notas-tab" data-bs-toggle="tab" data-bs-target="#notas" type="button" role="tab" aria-controls="notas" aria-selected="false">
                <i class="bi bi-star-fill me-1"></i> Notas das Habilidades
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="resumo-tab" data-bs-toggle="tab" data-bs-target="#resumo" type="button" role="tab" aria-controls="resumo" aria-selected="false">
                <i class="bi bi-file-text me-1"></i> Resumo Detalhado
            </button>
        </li>
    </ul>

    <div class="tab-content" id="avaliacaoTabsContent">
        <!-- Aba: Informações Gerais -->
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Informações Gerais</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p><strong><i class="bi bi-person me-1"></i> Funcionário Avaliado:</strong> {{ avaliacao.funcionario.nome }}</p>
                            <p><strong><i class="bi bi-person-check me-1"></i> Avaliador:</strong> {{ avaliacao.avaliador.nome }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p><strong><i class="bi bi-calendar me-1"></i> Data:</strong> {{ avaliacao.data_avaliacao.strftime('%d/%m/%Y %H:%M') }}</p>
                            <p><strong><i class="bi bi-emoji-smile me-1"></i> Sentimento:</strong> 
                                <span class="badge bg-{{ 'success' if avaliacao.sentimento == 'Positivo' else 'danger' if avaliacao.sentimento == 'Negativo' else 'warning' }}">
                                    {{ avaliacao.sentimento if avaliacao.sentimento else 'Não analisado' }}
                                </span>
                            </p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="mb-1"><strong><i class="bi bi-chat-left-text me-1"></i> Observações:</strong></p>
                        <div class="p-3 bg-light rounded">
                            {{ avaliacao.observacoes if avaliacao.observacoes else 'Nenhuma observação' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba: Notas das Habilidades -->
        <div class="tab-pane fade" id="notas" role="tabpanel" aria-labelledby="notas-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Notas das Habilidades</h5>
                    {% if itens %}
                        <!-- Gráfico das Notas -->
                        <div class="mb-4" style="height: 300px;">
                            <canvas id="graficoNotas"></canvas>
                        </div>
                        <!-- Tabela (colapsável) -->
                        <button class="btn btn-outline-primary btn-sm mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#tabelaNotas" aria-expanded="false" aria-controls="tabelaNotas">
                            <i class="bi bi-table"></i> Mostrar/Ocultar Tabela Detalhada
                        </button>
                        <div class="collapse" id="tabelaNotas">
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Categoria</th>
                                            <th>Habilidade</th>
                                            <th class="text-end">Nota</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in itens %}
                                            <tr>
                                                <td>{{ item.categoria }}</td>
                                                <td>{{ item.nome_habilidade }}</td>
                                                <td class="text-end">
                                                    <span class="badge bg-{{ 'success' if item.nota >= 4 else 'warning' if item.nota >= 2.5 else 'danger' }}">
                                                        {{ item.nota }}/5
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Nenhuma nota registrada para esta avaliação.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Aba: Resumo Detalhado -->
        <div class="tab-pane fade" id="resumo" role="tabpanel" aria-labelledby="resumo-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Resumo Detalhado</h5>
                    {% if resumo %}
                    <div class="bg-light p-3 rounded">
                        <p>{{ resumo | replace('**Pontos Fortes:**', '<strong class="text-success">Pontos Fortes:</strong>') | replace('**Áreas a Melhorar:**', '<strong class="text-warning">Áreas a Melhorar:</strong>') | replace('**Sugestões de Desenvolvimento:**', '<strong class="text-primary">Sugestões de Desenvolvimento:</strong>') | replace('\n', '</p><p>') | safe }}</p>
                    </div>
                        <form action="{{ url_for('regenerar_resumo', avaliacao_id=avaliacao.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-warning">
                                <i class="bi bi-arrow-repeat"></i> Regenerar Resumo
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Nenhum resumo disponível para esta avaliação.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <a href="{{ url_for('dashboard_colaboradores') }}" class="btn btn-secondary mt-3">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<!-- Script para o gráfico -->
{% if itens %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('graficoNotas').getContext('2d');
    
    // Preparar cores baseadas nas notas
    const backgroundColors = [];
    const borderColors = [];
    
    {% for item in itens %}
        {% if item.nota >= 4 %}
            backgroundColors.push('rgba(40, 167, 69, 0.7)');
            borderColors.push('rgba(40, 167, 69, 1)');
        {% elif item.nota >= 2.5 %}
            backgroundColors.push('rgba(255, 193, 7, 0.7)');
            borderColors.push('rgba(255, 193, 7, 1)');
        {% else %}
            backgroundColors.push('rgba(220, 53, 69, 0.7)');
            borderColors.push('rgba(220, 53, 69, 1)');
        {% endif %}
    {% endfor %}

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ itens | map(attribute='nome_habilidade') | list | tojson }},
            datasets: [{
                label: 'Nota',
                data: {{ itens | map(attribute='nota') | list | tojson }},
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw}/5`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}